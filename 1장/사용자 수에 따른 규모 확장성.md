
## 1장. 사용자 수에 따른 규모 확장성 

- 수백만 사용자를 지원하는 시스템을 설계하는 것은 도전적인 과제이며,
  지속적인 계량과 끝없는 개선이 요구되는 여정임 </br>
  이번 장에서는 한 명의 사용자를 지원하는 시스템에서 시작하여,
  최종적으로는 몇백만 사용자를 지원하는 시스템을 설계해볼 것임
   

## 단일 서버

- 천리 길도 한 걸음부터라는 말이 있듯, 복잡한 시스템을 만드는 것도 그와 크게 다르지 않음  
  모든 컴포넌트가 단 한 대의 서버에서 실행되는 간단한 시스템부터 설계해 봄  
  그림 1-1은 이 구성의 실제 사례임  
  웹 앱, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행됨  

- 이 그림의 시스템 구성을 이해하기 위해서는 사용자의 요청이 처리되는 과정과 요청을 만드는 단말에 대해서 이해할 필요가 있음
  사용자 요청 처리 흐름부터 살펴봄


1. 사용자는 도메인 이름(api.mysite.com)을 이용하여 웹사이트에 접속함  
   이 접속을 위해서는 도메인 이름을 도메인 이름 서비스(Domain Name Service)에 질의하여  
   IP 주소로 변환하는 과정이 필요함  
   DNS는 보통 제3 사업자(third party)가 제공하는 유료 서비스를 이용하게 되므로,  
   우리 시스템의 일부는 아님  
   
2. DNS 조회 결과로 IP 주소가 반환됨. 여기 예제에서는 그 주소가 15.125.23.214라고 함  
   이 주소는 그림 1-2에 나온 웹 서버의 주소임  
   
3. 해당 IP 주소로 HTTP(HyperText Transfer Protocol) 요청이 전달됨  

4. 요청을 받은 웹 서버는 HTML 페이지나 JSON 형태의 응답을 반환함  

- 이제 실제 요청이 어디로부터 오는지를 살펴봄  
  이 요청들은 두 가지 종류의 단말로부터 오는데, 하나는 웹 앱이고 다른 하나는 모바일 앱임  
  
1. 웹 애플리케이션: 비즈니스 로직, 데이터 저장 등을 처리하기 위해서는 서버 구현용 언어(자바, 파이썬 등)를 사용하고  
                    프레젠테이션용으로는 클라이언트 구현용 언어(HTML, 자바스크립트 등)를 사용함  
                    
2. 모바일 앱: 모바일 앱과 웹 서버 간 통신을 위해서는 HTTP 프로토콜을 이용함  
              HTTP 프로토콜을 통해서 반환될 응답 데이터의 포맷으로는 보통 JSON이 그 간결함 덕에 널리 쓰임  
              


## 데이터베이스

- 사용자가 늘면 서버 하나로는 충분하지 않아서 여러 서버를 두어야 함  
  하나는 웹/모바일  트래픽 처리 용도고, 다른 하나는 데이터베이스용임  
  웹/모바일 트래픽 처리 서버(웹 계층)와 데이터베이스 서버(데이터 계층)를 분리하면  
  그 각각을 독립적으로 확장해 나갈 수 있게 됨  
  

### 어떤 데이터베이스를 사용할 것인가?

- 전통적인 관계형 데이터베이스와 비-관계형 데이터베이스 사이에서 고를 수 있음  
  그 차이를 알아봄  
  관계형 데이터베이스는 관계형 데이터베이스 관리 시스템(RDBMS)라고도 부름  
  RDBMS 가운데 가장 유명한 것으로는 MySQL, 오라클 데이터베이스, PostgreSQL 등이 있음  
  관계형 데이터베이스는 자료를 테이블과 열, 칼럼으로 표현함  
  SQL을 사용하면 여러 테이블에 있는 데이터를 그 관계에 따라 조인(join)하여 합칠 수 있음  
  
- 비 관계형 데이터베이스는 NoSQL이라고도 부름  
  대표적인 것으로는 CouchDB, Neo4j, Cassandra, HBase, Amazon DynamoDB 등이 있음  
  NoSQL은 다시 네 부류로 나눌 수 있음  
  키-값 저장소(key-value store), 그래프 저장소(graph store), 칼럼 저장소(column store)  
  그리고 문서 저장소(document store)가 그것임  
  이런 비 관계형 데이터베이스는 일반적으로 조인 연산은 지원하지 않음  
  
- 대부분의 개발자에게는 관계형 데이터베이스가 최선일 것인데  
  40년 이상 시장에서 살아남아 잘 사용되어 온 시스템이라서임  
  하지만 여러분이 구축하려는 시스템에 적합하지 않은 경우에는  
  관계형 데이터베이스 이외의 저장소도 살펴보아야 함  
  아래와 같은 경우에는 비-관계형 데이터베이스가 바람직한 선택일 수 있음  
  
  (1) 아주 낮은 응답 지연시간(latency)가 요구됨
  (2) 다루는 데이터가 비정형(unstructured)이라 관계형 데이터가 아님  
  (3) 데이터(JSON, YAML, XML 등)를 직렬화하거나(serialize) 역직렬화(deserialize) 할 수 있기만 하면 됨     
  (4) 아주 많은 양의 데이터를 저장할 필요가 있음    
  

### 수직적 규모 확장 vs 수평적 규모 확장
  
- 소위 스케일 업(scale up)이라고도 하는 수직적 규모 확장(vertical scaling) 프로세스는   
  서버에 고사양 자원(더 좋은 CPU, 더 많은 RAM 등)을 추가하는 행위를 말함  
  반면 스케일 아웃(scale out)이라고도 하는 수평적 규모 확장 프로세스는  
  더 많은 서버를 추가하여 성능을 개선하는 행위를 말함  
  
- 서버로 유입되는 트래픽의 양이 적을 때는 수직적 확장이 좋은 선택이며,  
  이 방법의 가장 큰 장점은 단순함임  
  그러나 불행하게도 이 방법에는 몇 가지 심각한 단점이 있음  
  
  (1) 수직적 규모 확장에는 한계가 있음  
      한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법은 없음  
  (2) 수직적 규모 확장법은 장애에 대한 자동복구(failover) 방안이나 다중화(redundancy) 방안을 제시하지 않음  
      서버에 장애가 발생하면 웹사이트/앱은 완전히 중단됨  
      
  이런 단점 때문에, 대규모 애플리케이션을 지원하는 데는 수평적 규모 확장법이 보다 적절함  
  
  앞서 본 설계에서 사용자는 웹 서버에 바로 연결됨  
  웹 서버가 다운되면 사용자는 웹 사이트에 접속할 수 없음  
  또한, 너무 많은 사용자가 접속하여 웹 서버가 한계 상황에 도달하게 되면  
  응답 속도가 느려지거나 서버 접속이 불가능해질 수도 있음  
  이런 문제를 해결하는데는 부하 분산기 또는 로드밸런서(load balancer)를 도입하는 것이 최선임  
  

### 로드밸런서

- 로드밸런서는 부하 분산 집합(load balancing set)에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 함  
  그림 1-4는 로드밸런서가 어떻게 동작하는지 보여주고 있음  
  
- 그림 1-4와 같이, 사용자는 로드밸런서의 공개 IP 주소로 접속함  
  따라서 웹 서버는 클라이언트의 접속을 직접 처리하지 않음  
  더 나은 보안을 위해, 서버 간 통신에는 사설 IP 주소가 이용됨  
  사설 IP 주소는 같은 네트워크에 속한 서버 사이의 통신에만 쓰일 수 있는 IP 주소고,  
  인터넷을 통해서는 접속할 수 없음  
  로드밸런서는 웹 서버와 통신하기 위해 바로 이 사설 주소를 이용함  
  
- 그림 1-4에 나온대로, 부하 분산 집합에 또 하나의 웹 서버를 추가하고 나면,  
  장애를 자동복구하지 못하는 문제(no failover)는 해소되며, 
  웹 계층의 가용성(availability)은 향상됨  
  좀 더 구체적으로 살펴보면 다음과 같음  
  
  (1) 서버 1이 다운되면(offline) 모든 트래픽은 서버 2로 전송됨  
      따라서 웹 사이트 전체가 다운되는 일이 방지됨  
  (2) 웹사이트로 유입되는 트래픽이 가파르게 증가하면  
      두 대의 서버로 트래픽을 감당할 수 없는 시점이 오는데,  
      로드밸런서가 있으므로 우아하게 대처할 수 있음  
      웹 서버 계층에 더 많은 서버를 추가하기만 하면 됨  
      그러면 로드밸런서가 자동적으로 트래픽을 분산하기 시작함  
      
- 이제 웹 계층은 괜찮아 보이는데, 그렇다면 데이터 계층은 어떤가?  
  현재 설계 안에는 하나의 데이터베이스 서버뿐이고, 역시 장애의 자동복구나 다중화를 지원하는 구성은 아님  
  데이터베이스 다중화는 이런 문제를 해결하는 보편적인 기술임  
  

### 데이터베이스 다중화

- 위키피디아에 따르면, "많은 데이터베이스 관리 시스템이 다중화를 지원함"  
  보통은 서버 사이에 주(master)-부(slave) 관계를 설정하고,
  데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식임  
  
- 쓰기 연산(write operation)은 마스터에서만 지원함  
  부 데이터베이스는 주 데이터베이스로부터 그 사본을 전달 받으며,  
  읽기 연산(read operation)만을 지원함  
  데이터베이스를 변경하는 명령어들, 가령 insert, delete, update 등은  
  주 데이터베이스로만 전달되어야 함  
  
- 대부분의 애플리케이션은 읽기 연산의 비중이 쓰기 연산보다 훨씬 높음  
  따라서 통상 부 데이터베이스의 수가 주 데이터베이스의 수보다 많음  
  그림 1-5는 이 구성을 보여주고 있음  
  
- 데이터베이스를 다중화하면 다음과 같은 이득이 있음  
  
  (1) 더 나은 성능: 주-부 다중화 모델에서 모든 데이터 변경 연산은 주 데이터베이스 서버로만 전달되는 반면,  
                    읽기 연산은 부 데이터베이스 서버들로 분산됨  
                    병렬로 처리될 수 있는 질의(query)의 수가 늘어나므로, 성능이 좋아짐  
   
  (2) 안정성(reliability) : 자연 재해 등의 이유로 데이터베이스 서버 가운데 일부가 파괴되어도 데이터는 보존됨  
                            데이터를 지역적으로 떨어진 여러 장소에 다중화시켜 놓을 수 있기 때문임  
                            
  (3) 가용성(avaiilability) : 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스 서버에 장애가 발생하더라도  
                              다른 서버에 있는 데이터를 가져와 계속 서비스할 수 있게 됨  
                
  
 
